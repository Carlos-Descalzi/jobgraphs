apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
    name: "jobgraphs.ced.io"
spec:
  group: "ced.io"
  version: v1alpha1
  names:
    plural: jobgraphs
    singular: jobgraph
    kind: JobGraph
    listKind: JobGraphList
    shortNames:
      - mtj
  scope: Namespaced
  subresources: {}
  additionalPrinterColumns:
    - name: State
      type: string
      description: State
      JSONPath: .status.state
    - name: Start Time
      type: date
      description: Start Time
      JSONPath: .status.startTime
    - name: End Time
      type: date
      JSONPath: .status.endTime
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jobgraphs
  labels:
    name: jobgraphs
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: jobgraphs
  labels:
    name: jobgraphs
rules:
  - apiGroups: ['ced.io']
    resources: ['*']
    verbs: ['*']
  - apiGroups: ['batch']
    resources: ['jobs']
    verbs: ['*']
  - apiGroups: ['']
    resources: ['events']
    verbs: ['create', 'patch', 'update']
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: jobgraphs
  labels:
    name: jobgraphs
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jobgraphs
subjects:
  - kind: ServiceAccount
    name: jobgraphs
    namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jobgraphs
spec:
  replicas: 1
  selector:
    matchLabels:
      name: jobgraphs
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        name: jobgraphs
    spec:
      serviceAccountName: jobgraphs
      securityContext:
        fsGroup: 2 #daemon
      containers:
        - name: jobgraphs
          image: carlosdescalzi/jobgraphs:latest
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
